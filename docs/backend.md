# Backend

## Overview

The **Assets** backend is built using **Django** and **Django Ninja**, providing a clean, secure, and scalable API foundation. It handles authentication, wallet management, ticket operations, payment integration, and reporting. The backend adheres to RESTful principles and integrates seamlessly with the Next.js frontend.

---

## Tech Stack

| Category   | Technology                     | Purpose                                        |
| ---------- | ------------------------------ | ---------------------------------------------- |
| Framework  | **Django**                     | Core backend and ORM                           |
| API Layer  | **Django Ninja 1.4.x**         | Fast type-safe REST API using Pydantic models  |
| Database   | **PostgreSQL**                 | Relational storage with strong ACID guarantees |
| Auth       | **JWT + OAuth 2.0**            | Secure authentication and SSO support          |
| Testing    | **PyTest, Django Test Client** | Automated unit and integration testing         |
| Caching    | **Redis**                      | Session and rate-limit caching                 |
| Task Queue | **Celery**                     | Background jobs and notifications              |
| Deployment | **GHCR**                       | Easy deployment                                |
| Security   | **AES-256, SHA-256, HTTPS**    | Encryption and integrity                       |

---

## Project Structure

```
backend/
├── assets_backend/
│   ├── __init__.py
│   ├── settings.py         # Environment configs, middleware, installed apps
│   ├── urls.py             # Root routing configuration
│   ├── asgi.py / wsgi.py   # Server entry points
│   └── schema.py           # OpenAPI schema (generated by Django Ninja)
│
├── apps/
│   ├── auth/               # Authentication and OAuth modules
│   ├── wallet/             # Wallet + ledger management
│   ├── tickets/            # Asset lending and ticket lifecycle
│   ├── payments/           # Zarinpal integration
│   ├── reports/            # Dashboards and analytics
│   └── notifications/      # SMS, WhatsApp, email integration
│
├── tests/
│   ├── conftest.py
│   ├── test_auth.py
│   ├── test_wallet.py
│   └── test_tickets.py
│
├── requirements.txt
├── manage.py
└── Dockerfile
```

---

## App Overview

| App               | Description                                                    |
| ----------------- | -------------------------------------------------------------- |
| **auth**          | Handles JWT, OAuth 2.0, and user management.                   |
| **wallet**        | Implements user wallets and double-entry ledger system.        |
| **tickets**       | Core of the lending workflow (requests, approvals, lifecycle). |
| **payments**      | Integrates Zarinpal payment gateway and verification.          |
| **reports**       | Aggregates data for dashboards and analytics.                  |
| **notifications** | Sends SMS/WhatsApp/email updates.                              |

---

## Authentication & Authorization

### JWT Authentication

- Access and refresh tokens issued via `/auth/login/`.
- Stored securely as HttpOnly cookies.
- Token rotation and blacklist enabled via Django cache.

### OAuth 2.0

Supports third-party providers such as:

- Google
- GitHub
- Auth0

Upon OAuth login, the backend maps user profiles and issues JWTs.

---

## Wallet System

Implements **double-entry accounting** to ensure transaction accuracy.

| Action   | Debit         | Credit          |
| -------- | ------------- | --------------- |
| Deposit  | Bank Account  | Wallet          |
| Transfer | Sender Wallet | Receiver Wallet |
| Payment  | Wallet        | Ticket Escrow   |

All transactions are atomic and auditable via `ledger_entries`.

**Example model snippet:**

```python
class LedgerEntry(models.Model):
    wallet = models.ForeignKey("Wallet", on_delete=models.CASCADE)
    type = models.CharField(choices=[("credit", "Credit"), ("debit", "Debit")])
    amount = models.DecimalField(max_digits=18, decimal_places=2)
    ref = models.CharField(max_length=64, null=True, blank=True)
    description = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
```

---

## Tickets Module

Manages the end-to-end asset lending workflow.

| Status      | Description                      |
| ----------- | -------------------------------- |
| `pending`   | Awaiting lender approval         |
| `accepted`  | Approved, awaiting payment       |
| `active`    | Payment verified, loan ongoing   |
| `completed` | Loan duration ended successfully |
| `cancelled` | Request withdrawn or expired     |

**Example API endpoints:**

- `GET /tickets/` — List user tickets
- `POST /tickets/` — Create new lending request
- `PATCH /tickets/{id}/accept/` — Approve a ticket
- `PATCH /tickets/{id}/complete/` — Mark as completed

---

## Payments Module (Zarinpal)

Zarinpal integration ensures secure, traceable payments.

- Initiates payment on wallet recharge.
- Verifies transaction via callback from Zarinpal API.
- Updates wallet balances upon confirmation.

**Example flow:**

1. Create payment → `/payments/initiate/`
2. Redirect user to Zarinpal gateway
3. Verify callback → `/payments/verify/`
4. Update `payments` and `ledger_entries`

---

## Reports Module

Generates real-time and aggregated insights for dashboards.

| Metric           | Description                           |
| ---------------- | ------------------------------------- |
| `total_users`    | Total registered users                |
| `active_loans`   | Currently active lending transactions |
| `total_volume`   | Total monetary transaction volume     |
| `daily_activity` | Recent user actions summary           |

Data is aggregated nightly using a Celery task (optional).

---

## Notifications System

Supports multiple channels:

- **SMS** and **WhatsApp** (via API adapters)
- **Email** via Postmark or SendGrid

Each notification is logged in the database with delivery status.

**Example schema:**

```python
class Notification(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    channel = models.CharField(choices=[("sms", "SMS"), ("email", "Email"), ("whatsapp", "WhatsApp")])
    message = models.TextField()
    status = models.CharField(choices=[("queued", "Queued"), ("sent", "Sent"), ("failed", "Failed")])
    created_at = models.DateTimeField(auto_now_add=True)
```

---

## Testing

| Type        | Tool                      | Scope                           |
| ----------- | ------------------------- | ------------------------------- |
| Unit        | **PyTest**                | Models and utilities            |
| Integration | **Django Test Client**    | API endpoints                   |
| E2E         | **Playwright** (Frontend) | Combined frontend-backend flows |

Example command:

```bash
pytest -v --maxfail=1 --disable-warnings
```

---

## Deployment

### Environment Variables

```
SECRET_KEY=your_django_secret
DATABASE_URL=postgresql://user:pass@localhost:5432/assets
ZARINPAL_MERCHANT_ID=your_merchant_id
ZARINPAL_CALLBACK_URL=https://api.assets.example.com/api/v1/payments/verify/
JWT_SECRET=supersecret
DEBUG=False
ALLOWED_HOSTS=assets.example.com
```

### Docker Setup

```bash
docker build -t assets-backend .
docker run -p 8000:8000 assets-backend
```

### Migrations

```bash
python manage.py makemigrations
python manage.py migrate
```

---

## Performance Optimization

- Use **select_related** and **prefetch_related** to reduce query count.
- Add PostgreSQL **indexes** on foreign keys and frequently queried fields.
- Cache API responses for frequent reads.
- Configure **Gunicorn** workers for concurrency.

---

## Security Checklist

- Enforce HTTPS and secure cookies.
- Rotate JWT and refresh tokens periodically.
- Encrypt sensitive user data (AES-256).
- Use Django’s built-in CSRF protection.
- Regular vulnerability scans and dependency updates.
- Enable rate limiting and IP throttling.
